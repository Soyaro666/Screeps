var roleCollection = require('roleCollection');
var spawnCollection = require('spawnCollection');

module.exports.loop = function () {
	
	for(var name in Game.rooms) {
		var localSpawns = Game.rooms[name].find(FIND_MY_SPAWNS);
		if(localSpawns.length > 0) {
			var spawn = localSpawns[0].name;
			spawnCollection.run(name, spawn);
		}
		for(var builds in Game.rooms[name].structures) {
			if(Game.structures[name].structureType == STRUCTURE_TOWER) {
				var tower = Game.structures[name];
			}
			if(tower) {
				var closestHostile = tower.pos.findClosestByRange(FIND_HOSTILE_CREEPS);
				var closestDamagedStructure = tower.pos.findClosestByRange(FIND_MY_STRUCTURES, {
					filter: (structure) => structure.hits < structure.hitsMax
				});
				if(closestHostile) {
					tower.attack(closestHostile);
				} else if(closestDamagedStructure) {
					tower.repair(closestDamagedStructure);
				}
				var tower = false;
			}
		}
	}
	
	for(var name in Memory.creeps) {
        if(!Game.creeps[name]) {
			console.log('Creep '+name+' died.');
            delete Memory.creeps[name];
        } else {
		roleCollection.run(Game.creeps[name]);
		}
    }
}